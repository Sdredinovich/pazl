import s from "./Pazl.module.css";
import fermaBtn from "./../../photos/ferma.jpg";
import ferma3x3_1 from "./../../photos/ferma3x3_1.png";
import ferma3x3_2 from "./../../photos/ferma3x3_2.png";
import ferma3x3_3 from "./../../photos/ferma3x3_3.png";
import ferma3x3_4 from "./../../photos/ferma3x3_4.png";
import ferma3x3_5 from "./../../photos/ferma3x3_5.png";
import ferma3x3_6 from "./../../photos/ferma3x3_6.png";
import ferma3x3_7 from "./../../photos/ferma3x3_7.png";
import ferma3x3_8 from "./../../photos/ferma3x3_8.png";
import ferma3x3_9 from "./../../photos/ferma3x3_9.png";
import ferma4x4_1 from "./../../photos/ferma4x4_1.jpg";
import ferma4x4_2 from "./../../photos/ferma4x4_2.jpg";
import ferma4x4_3 from "./../../photos/ferma4x4_3.jpg";
import ferma4x4_4 from "./../../photos/ferma4x4_4.jpg";
import ferma4x4_5 from "./../../photos/ferma4x4_5.jpg";
import ferma4x4_6 from "./../../photos/ferma4x4_6.jpg";
import ferma4x4_7 from "./../../photos/ferma4x4_7.jpg";
import ferma4x4_8 from "./../../photos/ferma4x4_8.jpg";
import ferma4x4_9 from "./../../photos/ferma4x4_9.jpg";
import ferma4x4_10 from "./../../photos/ferma4x4_10.jpg";
import ferma4x4_11 from "./../../photos/ferma4x4_11.jpg";
import ferma4x4_12 from "./../../photos/ferma4x4_12.jpg";
import ferma4x4_13 from "./../../photos/ferma4x4_13.jpg";
import ferma4x4_14 from "./../../photos/ferma4x4_14.jpg";
import ferma4x4_15 from "./../../photos/ferma4x4_15.jpg";
import ferma4x4_16 from "./../../photos/ferma4x4_16.jpg";
import shrekBtn from "./../../photos/shrek.jpg";
import shrek3x3_1 from "./../../photos/shrek3x3_1.jpg";
import shrek3x3_2 from "./../../photos/shrek3x3_2.jpg";
import shrek3x3_3 from "./../../photos/shrek3x3_3.jpg";
import shrek3x3_4 from "./../../photos/shrek3x3_4.jpg";
import shrek3x3_5 from "./../../photos/shrek3x3_5.jpg";
import shrek3x3_6 from "./../../photos/shrek3x3_6.jpg";
import shrek3x3_7 from "./../../photos/shrek3x3_7.jpg";
import shrek3x3_8 from "./../../photos/shrek3x3_8.jpg";
import shrek3x3_9 from "./../../photos/shrek3x3_9.jpg";
import shrek4x4_1 from "./../../photos/shrek4x4_1.jpg";
import shrek4x4_2 from "./../../photos/shrek4x4_2.jpg";
import shrek4x4_3 from "./../../photos/shrek4x4_3.jpg";
import shrek4x4_4 from "./../../photos/shrek4x4_4.jpg";
import shrek4x4_5 from "./../../photos/shrek4x4_5.jpg";
import shrek4x4_6 from "./../../photos/shrek4x4_6.jpg";
import shrek4x4_7 from "./../../photos/shrek4x4_7.jpg";
import shrek4x4_8 from "./../../photos/shrek4x4_8.jpg";
import shrek4x4_9 from "./../../photos/shrek4x4_9.jpg";
import shrek4x4_10 from "./../../photos/shrek4x4_10.jpg";
import shrek4x4_11 from "./../../photos/shrek4x4_11.jpg";
import shrek4x4_12 from "./../../photos/shrek4x4_12.jpg";
import shrek4x4_13 from "./../../photos/shrek4x4_13.jpg";
import shrek4x4_14 from "./../../photos/shrek4x4_14.jpg";
import shrek4x4_15 from "./../../photos/shrek4x4_15.jpg";
import shrek4x4_16 from "./../../photos/shrek4x4_16.jpg";
import mashaBtn from "./../../photos/masha.jpg";
import masha3x3_1 from "./../../photos/masha3x3_1.jpg";
import masha3x3_2 from "./../../photos/masha3x3_2.jpg";
import masha3x3_3 from "./../../photos/masha3x3_3.jpg";
import masha3x3_4 from "./../../photos/masha3x3_4.jpg";
import masha3x3_5 from "./../../photos/masha3x3_5.jpg";
import masha3x3_6 from "./../../photos/masha3x3_6.jpg";
import masha3x3_7 from "./../../photos/masha3x3_7.jpg";
import masha3x3_8 from "./../../photos/masha3x3_8.jpg";
import masha3x3_9 from "./../../photos/masha3x3_9.jpg";
import masha4x4_1 from "./../../photos/masha4x4_1.jpg";
import masha4x4_2 from "./../../photos/masha4x4_2.jpg";
import masha4x4_3 from "./../../photos/masha4x4_3.jpg";
import masha4x4_4 from "./../../photos/masha4x4_4.jpg";
import masha4x4_5 from "./../../photos/masha4x4_5.jpg";
import masha4x4_6 from "./../../photos/masha4x4_6.jpg";
import masha4x4_7 from "./../../photos/masha4x4_7.jpg";
import masha4x4_8 from "./../../photos/masha4x4_8.jpg";
import masha4x4_9 from "./../../photos/masha4x4_9.jpg";
import masha4x4_10 from "./../../photos/masha4x4_10.jpg";
import masha4x4_11 from "./../../photos/masha4x4_11.jpg";
import masha4x4_12 from "./../../photos/masha4x4_12.jpg";
import masha4x4_13 from "./../../photos/masha4x4_13.jpg";
import masha4x4_14 from "./../../photos/masha4x4_14.jpg";
import masha4x4_15 from "./../../photos/masha4x4_15.jpg";
import masha4x4_16 from "./../../photos/masha4x4_16.jpg";
import { useEffect, useState } from "react";
const ferma = {
  '3x3':[
  ferma3x3_1,
  ferma3x3_2,
  ferma3x3_3,
  ferma3x3_4,
  ferma3x3_5,
  ferma3x3_6,
  ferma3x3_7,
  ferma3x3_8,
  ferma3x3_9,
  ],
'4x4':[
  ferma4x4_1,
  ferma4x4_2,
  ferma4x4_3,
  ferma4x4_4,
  ferma4x4_5,
  ferma4x4_6,
  ferma4x4_7,
  ferma4x4_8,
  ferma4x4_9,
  ferma4x4_10,
  ferma4x4_11,
  ferma4x4_12,
  ferma4x4_13,
  ferma4x4_14,
  ferma4x4_15,
  ferma4x4_16,


]};
const masha = {'3x3':[
  masha3x3_1,
  masha3x3_2,
  masha3x3_3,
  masha3x3_4,
  masha3x3_5,
  masha3x3_6,
  masha3x3_7,
  masha3x3_8,
  masha3x3_9,
],
'4x4':[
  masha4x4_1,
  masha4x4_2,
  masha4x4_3,
  masha4x4_4,
  masha4x4_5,
  masha4x4_6,
  masha4x4_7,
  masha4x4_8,
  masha4x4_9,
  masha4x4_10,
  masha4x4_11,
  masha4x4_12,
  masha4x4_13,
  masha4x4_14,
  masha4x4_15,
  masha4x4_16,
]}
const shrek = {'3x3':[
  shrek3x3_1,
  shrek3x3_2,
  shrek3x3_3,
  shrek3x3_4, 
  shrek3x3_5, 
  shrek3x3_6, 
  shrek3x3_7, 
  shrek3x3_8,
  shrek3x3_9
],
'4x4':[
  shrek4x4_1,
  shrek4x4_2,
  shrek4x4_3,
  shrek4x4_4,
  shrek4x4_5,
  shrek4x4_6,
  shrek4x4_7,
  shrek4x4_8,
  shrek4x4_9,
  shrek4x4_10,
  shrek4x4_11,
  shrek4x4_12,
  shrek4x4_13,
  shrek4x4_14, 
  shrek4x4_15,
  shrek4x4_16,

]}

const positions3x3 = {   
  1: 1,
  2: 2,
  3: 3,
  4: 4,
  5: 5,
  6: 6,
  7: 7,
  8: 8,
  9: 9,
}

  const positions4x4 ={
      1: 1,
      2: 2,
      3: 3,
      4: 4,
      5: 5,
      6: 6,
      7: 7,
      8: 8,
      9: 9,
      10:10,
      11:11,
      12:12,
      13:13,
      14:14,
      15:15,
      16:16,
  }

  const mode4x4 = {
    'placement':'4x4',
    'leftErr': [4, 8, 12],
    'rightErr': [5, 9, 13],
    'step':4
  
  }
  const mode3x3 = {
    'placement':'3x3',
    'leftErr': [3, 6],
    'rightErr': [4, 7],
    'step':3
  
  }
export const Pazl = (props) => {


console.log('отрисовка');


  const [start, setStart] = useState(false)
  const [hidNum, setHidnum] = useState(null)
  const [state, setState] = useState(positions3x3);
const [mode, setMode] = useState(mode3x3)
const [currentPhoto, setCurrentPhoto] = useState(ferma)

  
  function gameOver(obj, hidNum) {
    //Возвращает массив с ключами, кроме"hidNum" 
    let keysArr = Object.keys(obj).filter(key=>+key!==hidNum)
    // Проверяет, все ли элементы находятся на своих позициях и возвращает значение
    return keysArr.every((key) => +key === obj[key]);
  }

  function getKeyByValue(object, value) { 
    //Находит ключ по значению и возвращает его
    return Object.keys(object).find((key) => object[key] === value);
  }
  function changeMode(newPositions, newMode ){
    if(newMode!==mode){
      setMode(newMode)
      setState(newPositions)
      setStart(false)
    }
    
  }
function changeCurrentPhoto(photo){
  if(currentPhoto!==photo){
    const keysArr = Object.keys(state)
    const newObj = {}
    keysArr.map((value, index)=>{
      newObj[index+1]=+index+1
    })
  setState(newObj)
  setStart(false)
  setCurrentPhoto(photo)
  }
}
  const keyDown = (e) => {
  const vpravo = () => {
    if (
      state[state[hidNum] - 1] &&
      state[hidNum] !== mode.rightErr[0] &&
      state[hidNum]  !== mode.rightErr[1]
    ) {
if(mode.placement =='4x4'&&state[hidNum]!== mode.rightErr[2]){
  const twoNum = getKeyByValue(state, state[hidNum] - 1);
  setState({
    ...state,
    [hidNum]: state[hidNum] - 1,
    [+twoNum]: state[hidNum],
  });
} else if(mode.placement =='3x3'){
 
  const twoNum = getKeyByValue(state, state[hidNum] - 1);
  setState({
    ...state,
    [hidNum]: state[hidNum] - 1,
    [+twoNum]: state[hidNum],
  });
}
 
    }
  };
  const vlevo = () => {
    if (
      state[state[hidNum] + 1] &&
      state[hidNum]  !== mode.leftErr[0] &&
      state[hidNum]  !== mode.leftErr[1]
  
    ) {

      if(mode.placement =='4x4'&&state[hidNum]  !== mode.leftErr[2]){
        const twoNum = getKeyByValue(state, state[hidNum] + 1);
        setState({
          ...state,
          [hidNum]: state[hidNum] + 1,
          [+twoNum]: state[hidNum],
        });
      }
      else if(mode.placement =='3x3'){

        const twoNum = getKeyByValue(state, state[hidNum] + 1);
        setState({
          ...state,
          [hidNum]: state[hidNum] + 1,
          [+twoNum]: state[hidNum],
        });
      }

    }
  };
  const vniz = () => {
    if (state[state[hidNum] - mode.step]) {
      const twoNum = getKeyByValue(state, state[hidNum] - mode.step);
      setState({
        ...state,
        [hidNum]: state[hidNum] - mode.step,
        [+twoNum]: state[hidNum],
      });
    }
  };
  const vverh = () => {
    if (state[+state[hidNum] + mode.step]) {
      const twoNum = getKeyByValue(state, state[hidNum] + mode.step);
      setState({
        ...state,
        [hidNum]: state[hidNum] + mode.step,
        [twoNum]: state[hidNum],
      });
    }
  };

    switch (e.keyCode) {
      case 40:
        vniz();
        break;
      case 38:
        vverh();
        break;
      case 39:
        vpravo();
        break;
      case 37:
        vlevo();
        break;
      default:
        break;
    }
  };
  function mixer(obj) {

    // Перемешивает пазл
    const mixedArr = Object.keys(obj).sort(() => Math.random() - 0.5);
    const newObj = {}
    mixedArr.map((value, index)=>{
      newObj[index+1]=+value
    })
    // Выбирает случайный элемент массива(фото, чтобы вытащить его из пазла)
    let rand = Math.floor(Math.random() * mixedArr.length);
     setHidnum(mixedArr[rand])
    setState({...newObj})
    // Запускает игру
    setStart(true)

  }

  useEffect(()=>{
    gameOver(state, hidNum)&&start&&setStart(false)
  }, [state])

  return (
    <div autoFocus tabIndex="0" onKeyDown={start?keyDown:undefined} className={s.pazl}>
      <div className={s.pazlContent}>
        <div className={s.selectDiv}>
          <img onClick={()=>{changeCurrentPhoto(ferma)}} alt="Выбираемое фото" src={fermaBtn} className={`${s.selectPhotoImg} ${currentPhoto==ferma&&s.current}`}/>
          <img onClick={()=>{changeCurrentPhoto(shrek)}} alt="Выбираемое фото" src={shrekBtn} className={`${s.selectPhotoImg} ${currentPhoto==shrek&&s.current}`}/>
          <img onClick={()=>{changeCurrentPhoto(masha)}} alt="Выбираемое фото" src={mashaBtn} className={`${s.selectPhotoImg} ${currentPhoto==masha&&s.current}`}/>
        
        </div>
        <div>
      <div className={s.gameWindow}>
        {currentPhoto[mode.placement].map((element, id) => {
          return (<div key={id}className={`
          ${s.element} 
          ${s['element' + mode.placement]} 
          ${!start&&s['offBorder'+mode.placement]} 
          ${s["element" + state[id + 1]+mode.placement]} 
          ${hidNum == id + 1 && start && s.missing} 
          ${hidNum == id + 1 && !start && s.missing2} 
          ${start && s['startEl'+mode.placement]}`}>
         <img className={`${s.elementImg} `} src={element} />
            </div>
          );
        })}
        <div className={s.emptyDiv}>
          
        </div>
      </div>
      <button  className={s.startBtn} disabled={start} onClick={()=>{
        mixer(state)

      }}>Начать</button>
      </div>
      <div className={s.selectDiv}>
        <button  onClick={()=>{
          changeMode(positions3x3, mode3x3)
        }} className={`${s.selectModeBtn} ${mode===mode3x3&&s.current}`}>3x3</button>
        <button onClick={()=>{
                  changeMode(positions4x4, mode4x4)

        }} className={`${s.selectModeBtn} ${mode!==mode3x3&&s.current}`}>4x4</button>
        </div>
      </div>

    </div>
  );
};
